
services:



  api:
    build:
      context: ${PROJECT_ROOT}
      dockerfile: docker/dev/Dockerfile.api.dev
    environment:
      PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
      DATASOURCE_URL: ${SPRING_DATASOURCE_URL}
      DATASOURCE_USERNAME: ${POSTGRES_USER}
      DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD}
      SERVER_PORT: ${SERVER_PORT}

    env_file:
      - ${PROJECT_ROOT}/config/.env.dev
      - ${PROJECT_ROOT}/.env.local
      - ${PROJECT_ROOT}/.env

    ports:
      - "8080:8080"
      - "5005:5005"  # Debug port
    volumes:
      # Volume mount for hot reload - critical for development
      - ${PROJECT_ROOT}/apps/api/src:/app/apps/api/src
      - ${PROJECT_ROOT}/apps/api/pom.xml:/app/apps/api/pom.xml
      - ${PROJECT_ROOT}/apps/api/target:/app/apps/api/target
      - ${PROJECT_ROOT}/apps/api/mvnw:/app/apps/api/mvnw
      # Maven cache to avoid re-downloading dependencies
      - maven-cache-dev:/root/.m2
    # command: sleep infinity
    # depends_on:
    #   db:
    #     condition: service_healthy


  admin:
    build:
      context: ${PROJECT_ROOT}
      dockerfile: docker/dev/Dockerfile.admin.dev
    restart: unless-stopped
    ports:
      - '${ADMIN_PORT}:${ADMIN_PORT}'
    volumes:
      - ${PROJECT_ROOT}/apps/admin/src:/app/apps/admin/src
      - ${PROJECT_ROOT}/apps/admin/public:/app/apps/admin/public
      - ${PROJECT_ROOT}/apps/admin/package.json:/app/apps/admin/package.json
      - ${PROJECT_ROOT}/apps/admin/vite.config.ts:/app/apps/admin/vite.config.ts
      # Prevent node_modules from being overwritten
      # - /app/node_modules
    environment:
      VITE_API_URL : ${API_URL}
      VITE_NODE_ENV : ${NODE_ENV}
      VITE_ADMIN_PORT : ${ADMIN_PORT}
      CHOKIDAR_USEPOLLING : true
      WATCHPACK_POLLING : true

    env_file:
      - ${PROJECT_ROOT}/config/.env.dev
      - ${PROJECT_ROOT}/.env.local
      - ${PROJECT_ROOT}/.env

    depends_on:
      - api





  db:
    image: postgres:15-alpine
    restart: unless-stopped  # More professional than "always"
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}

    ports:
      - "5432:5432"
    env_file:
      - ${PROJECT_ROOT}/config/.env.dev
      - ${PROJECT_ROOT}/.env.local
      - ${PROJECT_ROOT}/.env

    volumes:
      - postgres-data-dev:/var/lib/postgresql/data

  db-backup:
    image: postgres:alpine
    
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_DB: ${POSTGRES_DB}
      DB_CONTAINER_NAME: db
    
    volumes:
      - ${PROJECT_ROOT}/scripts/backup.sh:/backup.sh
      - ${PROJECT_ROOT}/scripts/restore.sh:/restore.sh
      - ${PROJECT_ROOT}/backup:/backup
    
    entrypoint: /bin/bash
    command: -c "while true; chmod +x /backup.sh;chmod +x /restore.sh; do /backup.sh; sleep 86400; done"

    
    restart: unless-stopped


volumes:
  postgres-data-dev:
    # driver: local
  maven-cache-dev:
    # driver: local